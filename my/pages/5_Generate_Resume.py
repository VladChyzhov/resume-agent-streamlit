import streamlit as st
import db
from datetime import datetime
import json

def generate_text_resume(personal_info, user_data, skills, languages, education_docs, work_docs):
    """Generate a text version of the resume"""
    lines = []
    
    # Header
    if personal_info:
        lines.append("=" * 50)
        lines.append(f"–†–ï–ó–Æ–ú–ï: {personal_info[0] or '–ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}")
        lines.append("=" * 50)
        lines.append("")
        
        if personal_info[1]:
            lines.append(f"Email: {personal_info[1]}")
        if personal_info[2]:
            lines.append(f"–¢–µ–ª–µ—Ñ–æ–Ω: {personal_info[2]}")
        lines.append("")
    
    # Work Experience
    if "work_experience" in user_data and user_data["work_experience"]:
        lines.append("–û–ü–´–¢ –†–ê–ë–û–¢–´")
        lines.append("-" * 20)
        for work in user_data["work_experience"]:
            lines.append(f"{work['position']} - {work['company']}")
            start_date = work['start_date'] if work['start_date'] else "–ù–µ —É–∫–∞–∑–∞–Ω–æ"
            end_date = "–ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è" if work['is_current'] else (work['end_date'] if work['end_date'] else "–ù–µ —É–∫–∞–∑–∞–Ω–æ")
            lines.append(f"–ü–µ—Ä–∏–æ–¥: {start_date} - {end_date}")
            
            if work['responsibilities']:
                lines.append("–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:")
                for resp in work['responsibilities'].split('\n'):
                    if resp.strip():
                        lines.append(f"‚Ä¢ {resp.strip()}")
            lines.append("")
    
    # Education
    if "education_info" in user_data and user_data["education_info"]:
        lines.append("–û–ë–†–ê–ó–û–í–ê–ù–ò–ï")
        lines.append("-" * 20)
        for edu in user_data["education_info"]:
            lines.append(f"{edu['degree']} - {edu['field']}")
            lines.append(f"{edu['institution']}")
            lines.append(f"{edu['start_year']} - {edu['end_year']}")
            if edu['gpa']:
                lines.append(f"–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: {edu['gpa']}")
            lines.append("")
    
    # Skills
    if skills:
        lines.append("–ù–ê–í–´–ö–ò")
        lines.append("-" * 20)
        for skill_id, skill_name, skill_level, category in skills:
            lines.append(f"‚Ä¢ {skill_name} ({skill_level})")
        lines.append("")
    
    # Languages
    if languages:
        lines.append("–Ø–ó–´–ö–ò")
        lines.append("-" * 20)
        for lang_id, language_name, proficiency_level in languages:
            lines.append(f"‚Ä¢ {language_name} - {proficiency_level}")
    
    return "\n".join(lines)

if st.session_state.get("user_id") is None:
    st.switch_page("pages/0_Auth.py")

st.title("üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∑—é–º–µ")

# Get user data
user_data = st.session_state.get("data", {})
user_id = st.session_state.user_id

# Load fresh data from database
personal_info = db.load_personal_info(user_id)
skills = db.list_skills(user_id)
languages = db.list_languages(user_id)

# Get document counts
education_docs = []
work_docs = []
for category in ["education_diploma", "education_certificate", "education_transcript", "education_other"]:
    education_docs.extend(db.list_documents(user_id, category))

for category in ["work_employment_certificate", "work_recommendation", "work_contract", "work_portfolio", "work_other"]:
    work_docs.extend(db.list_documents(user_id, category))

# Resume generation options
st.subheader("‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–∑—é–º–µ")

col1, col2 = st.columns(2)
with col1:
    resume_style = st.selectbox(
        "–°—Ç–∏–ª—å —Ä–µ–∑—é–º–µ",
        ["professional", "modern", "creative"],
        format_func=lambda x: {
            "professional": "üè¢ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π",
            "modern": "üíº –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π", 
            "creative": "üé® –ö—Ä–µ–∞—Ç–∏–≤–Ω—ã–π"
        }[x]
    )

with col2:
    include_photo = st.checkbox("–í–∫–ª—é—á–∏—Ç—å —Ñ–æ—Ç–æ", value=True if personal_info and personal_info[3] else False)

# Resume preview
st.subheader("üëÄ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—é–º–µ")

if personal_info:
    # Header section
    st.markdown("---")
    
    # Create header with photo if available
    if include_photo and personal_info[3]:
        col_photo, col_info = st.columns([1, 3])
        with col_photo:
            st.image(personal_info[3], width=150, caption="")
        with col_info:
            st.markdown(f"# {personal_info[0] or '–ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}")
            if personal_info[1]:
                st.markdown(f"üìß **Email:** {personal_info[1]}")
            if personal_info[2]:
                st.markdown(f"üì± **–¢–µ–ª–µ—Ñ–æ–Ω:** {personal_info[2]}")
    else:
        st.markdown(f"# {personal_info[0] or '–ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}")
        if personal_info[1]:
            st.markdown(f"üìß **Email:** {personal_info[1]}")
        if personal_info[2]:
            st.markdown(f"üì± **–¢–µ–ª–µ—Ñ–æ–Ω:** {personal_info[2]}")
    
    st.markdown("---")
    
    # Work Experience Section
    if "work_experience" in user_data and user_data["work_experience"]:
        st.markdown("## üíº –û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã")
        for work in user_data["work_experience"]:
            st.markdown(f"### {work['position']}")
            st.markdown(f"**{work['company']}**")
            
            # Format dates
            start_date = work['start_date'] if work['start_date'] else "–ù–µ —É–∫–∞–∑–∞–Ω–æ"
            if work['is_current']:
                end_date = "–ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è"
            else:
                end_date = work['end_date'] if work['end_date'] else "–ù–µ —É–∫–∞–∑–∞–Ω–æ"
            
            st.markdown(f"*{start_date} - {end_date}*")
            
            if work['company_description']:
                st.markdown(f"**–û –∫–æ–º–ø–∞–Ω–∏–∏:** {work['company_description']}")
            
            if work['responsibilities']:
                st.markdown("**–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**")
                # Split by lines and format as bullet points
                responsibilities = work['responsibilities'].split('\n')
                for resp in responsibilities:
                    if resp.strip():
                        st.markdown(f"‚Ä¢ {resp.strip()}")
            
            if work['technologies']:
                st.markdown(f"**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** {work['technologies']}")
            
            st.markdown("")
    
    # Education Section
    if "education_info" in user_data and user_data["education_info"]:
        st.markdown("## üéì –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ")
        for edu in user_data["education_info"]:
            st.markdown(f"### {edu['degree']} - {edu['field']}")
            st.markdown(f"**{edu['institution']}**")
            st.markdown(f"*{edu['start_year']} - {edu['end_year']}*")
            
            if edu['gpa']:
                st.markdown(f"**–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª:** {edu['gpa']}")
            if edu['honors']:
                st.markdown(f"**–ù–∞–≥—Ä–∞–¥—ã –∏ –æ—Ç–ª–∏—á–∏—è:** {edu['honors']}")
            st.markdown("")
    
    # Skills Section
    if skills:
        st.markdown("## üõ†Ô∏è –ù–∞–≤—ã–∫–∏")
        
        # Group skills by category
        skill_categories = {}
        for skill_id, skill_name, skill_level, category in skills:
            if category not in skill_categories:
                skill_categories[category] = []
            skill_categories[category].append((skill_name, skill_level))
        
        for category, category_skills in skill_categories.items():
            category_name = {
                "technical": "üíª –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏",
                "creative": "üé® –¢–≤–æ—Ä—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏",
                "management": "üë• –£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏",
                "communication": "üí¨ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –Ω–∞–≤—ã–∫–∏"
            }.get(category, f"üìÇ {category}")
            
            st.markdown(f"### {category_name}")
            
            # Display skills in columns for better layout
            skill_cols = st.columns(3)
            for i, (skill_name, skill_level) in enumerate(category_skills):
                level_display = {
                    "beginner": "‚≠ê –ù–∞—á–∏–Ω–∞—é—â–∏–π",
                    "intermediate": "‚≠ê‚≠ê –°—Ä–µ–¥–Ω–∏–π",
                    "advanced": "‚≠ê‚≠ê‚≠ê –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π",
                    "expert": "‚≠ê‚≠ê‚≠ê‚≠ê –≠–∫—Å–ø–µ—Ä—Ç"
                }.get(skill_level, skill_level)
                
                with skill_cols[i % 3]:
                    st.markdown(f"**{skill_name}**")
                    st.caption(level_display)
            st.markdown("")
    
    # Languages Section
    if languages:
        st.markdown("## üåç –Ø–∑—ã–∫–∏")
        lang_cols = st.columns(2)
        for i, (lang_id, language_name, proficiency_level) in enumerate(languages):
            with lang_cols[i % 2]:
                st.markdown(f"**{language_name}** - {proficiency_level}")
    
    # Documents Section
    if education_docs or work_docs:
        st.markdown("## üìÅ –ü—Ä–∏–ª–æ–∂–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã")
        
        col_edu, col_work = st.columns(2)
        
        with col_edu:
            if education_docs:
                st.markdown("### üéì –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ")
                st.markdown(f"–î–æ–∫—É–º–µ–Ω—Ç–æ–≤: {len(education_docs)}")
        
        with col_work:
            if work_docs:
                st.markdown("### üíº –û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã")
                st.markdown(f"–î–æ–∫—É–º–µ–Ω—Ç–æ–≤: {len(work_docs)}")
    
    st.markdown("---")
    
    # Export options
    st.subheader("üì§ –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—é–º–µ")
    
    col_export1, col_export2, col_export3 = st.columns(3)
    
    with col_export1:
        if st.button("üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ —Ç–µ–∫—Å—Ç", type="secondary"):
            # Generate text version
            resume_text = generate_text_resume(personal_info, user_data, skills, languages, education_docs, work_docs)
            st.download_button(
                label="‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å TXT",
                data=resume_text,
                file_name=f"resume_{personal_info[0] or 'user'}_{datetime.now().strftime('%Y%m%d')}.txt",
                mime="text/plain"
            )
    
    with col_export2:
        if st.button("üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä", type="secondary"):
            resume_text = generate_text_resume(personal_info, user_data, skills, languages, education_docs, work_docs)
            st.code(resume_text, language="text")
            st.success("–†–µ–∑—é–º–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è!")
    
    with col_export3:
        st.button("üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF", type="primary", help="–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ")
        st.caption("PDF —ç–∫—Å–ø–æ—Ä—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏")

else:
    st.warning("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.")
    if st.button("–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º"):
        st.switch_page("pages/1_Personal_Info.py")

# Statistics
st.subheader("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è")

col_stat1, col_stat2, col_stat3, col_stat4 = st.columns(4)

with col_stat1:
    personal_complete = 1 if personal_info and personal_info[0] else 0
    st.metric("–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ", "‚úÖ" if personal_complete else "‚ùå")

with col_stat2:
    work_complete = len(user_data.get("work_experience", []))
    st.metric("–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã", f"{work_complete} –∑–∞–ø–∏—Å–µ–π")

with col_stat3:
    skills_complete = len(skills)
    st.metric("–ù–∞–≤—ã–∫–∏", f"{skills_complete} —à—Ç.")

with col_stat4:
    docs_complete = len(education_docs) + len(work_docs)
    st.metric("–î–æ–∫—É–º–µ–Ω—Ç—ã", f"{docs_complete} —à—Ç.")

# Completion progress
total_sections = 4
completed_sections = 0
if personal_complete:
    completed_sections += 1
if work_complete > 0:
    completed_sections += 1
if skills_complete > 0:
    completed_sections += 1
if docs_complete > 0:
    completed_sections += 1

progress = completed_sections / total_sections
st.progress(progress)
st.caption(f"–ó–∞–ø–æ–ª–Ω–µ–Ω–æ: {completed_sections}/{total_sections} —Ä–∞–∑–¥–µ–ª–æ–≤ ({progress:.0%})")
